'use strict';class u{constructor(a,c,d){this.name=d;this.i=`${c}${d}`;switch(a){case "uniform":this.type=1;if("u_"!==c)throw Error(`uniform field "${this.i}" invalid, must start with u_`);break;case "in":this.type=2;if("a_"!==c)throw Error(`in field "${this.i}" invalid, must start with a_`);break;default:throw Error("Impossible");}}}function v(a){const c=[];a.split("\n").forEach(d=>{(d=/^\s*(in|uniform)\s(?:\w+\s)*([ua]_)(\w+);/.exec(d))&&c.push(new u(d[1],d[2],d[3]))});return c}
const w=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);function x(a,c,d=0){var b=a.a;b=b[b.length-1]||w;c=new Float32Array([b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],c*b[0]+0*b[4]+d*b[8]+b[12],c*b[1]+0*b[5]+d*b[9]+b[13],c*b[2]+0*b[6]+d*b[10]+b[14],c*b[3]+0*b[7]+d*b[11]+b[15]]);a.b.uniformMatrix4fv(a.c,!1,c);a.a.push(c)}class y{constructor(a,c){this.b=a;this.c=c;this.a=[];a.uniformMatrix4fv(c,!1,w)}pop(){return this.a.pop()}}
class z{constructor(a,c){this.name=a.name;var d=this.b=a.b;a=this.type=a.type;switch(a){case "vertex":var b=this.b.VERTEX_SHADER;break;case "fragment":b=this.b.FRAGMENT_SHADER;break;default:throw Error(`Unrecognized shader type "${a}"`);}b=this.a=d.createShader(b);d.shaderSource(b,c);d.compileShader(b);if(!d.getShaderParameter(b,d.COMPILE_STATUS))throw c=`Failed to compile ${this.name} ${a}-shader: ${d.getShaderInfoLog(b)}`,d.deleteShader(b),Error(c);this.s=v(c)}}
function A(a,...c){const d=a.b,b=a.c;c.forEach(e=>{a.f.push(e);d.attachShader(b,e.a)});return a}
class B{constructor(a){this.name=a.name;this.m=a.m;a=this.b=a.b;this.h=!1;this.c=a.createProgram();this.f=[];this.j={};this.g={};this.stack=null;this.a=[];this.l=()=>{var c=this.b,d=this.c;c.useProgram(d);for(var b={},e={},h=this.f,f=0;f<h.length;f++)for(var m=h[f].s,n=0;n<m.length;n++){var k=m[n];1===k.type?k.i in b||(b[k.name]=c.getUniformLocation(d,k.i)):k.i in e||(e[k.name]=c.getAttribLocation(d,k.i))}this.j=b;this.g=e;if(d=this.m)if(d in this.j)this.stack=new y(c,this.j[d]);else throw Error(`No anchor point "${d}" in program`);
console.log(b,e);try{var p=this.a;for(f=0;f<p.length;p++)p[f](c,this)}finally{this.j={},this.g={},this.stack=null,1===this.a.length?this.a=[]:this.a.pop()}}}link(){if(this.h)return this;var a=this.b,c=this.c;a.linkProgram(c);if(!a.getProgramParameter(c,a.LINK_STATUS)){var d=`Failed to link ${this.name} program: ${a.getProgramInfoLog(c)}`;a.deleteProgram(c);throw Error(d);}this.h=!0;return this}}
class C{constructor(a,c,d,b,e){this.b=a;this.name=c;this.w=d;c=this.a=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);e(a);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.bindTexture(a.TEXTURE_2D,null)}bindTexture(){this.b.bindTexture(this.b.TEXTURE_2D,this.a)}}function D(a){const c=a.width,d=a.height;return new C(a.b,a.name,c,d,b=>{b.texImage2D(b.TEXTURE_2D,0,b.RGBA,c,d,0,b.RGBA,b.UNSIGNED_BYTE,a.v,0)})};class E{constructor(){this.o=null;this.f=60;this.a=this.c=0;this.l=()=>{{const c=this.a;var a=Date.now();const d=this.h;0!==d&&(this.c=1E3/(a-d)*.1+.9*this.c);this.h=a;try{const b=this.o;b()}finally{a=1E3/this.f-(Date.now()-a),this.a===c&&(this.a=setTimeout(this.l,Math.max(a,0)))}}};this.h=0}start(a=this.f){this.f=a;this.a||(this.h=0,this.c=a,this.a=setTimeout(this.l,0))}};function F(a,c){if(!a.data.hasOwnProperty(c))throw Error(`Can not render unknown "${c}"`);c=a.data[c];a=a.a.b;a.drawArrays(a.TRIANGLE_STRIP,c.u[0],c.A)}
class G{constructor(a,c){this.a=a;this.c=null;a=this.data={};const d=[];let b=0;for(const e in c){const h=c[e],f=[],m=h.length;if(0===m)throw Error("Sprite declared with 0 points");const n=h[0].length;if(0==n)throw Error("Sprite declared with list of length 5 (must be non-zero multiple of 5)");const k=n/5;for(let p=0;p<m;p++){const q=h[p];if(q.length!==n)throw Error("Sprite declared with inconsistent lengths of elements");f.push(b);d.push.apply(d,q);b+=k}a[e]={B:this,name:e,u:f,A:k}}this.f=new Float32Array(d)}}
;function H(){const a=new Uint8Array(4096);for(let e=0;32>e;e++)for(let h=0;32>h;h++){const f=4*(32*e+h);var c=h-16,d=e-16;c=c*c+d*d;if(9>=c)a[f]=255,a[f+1]=255,a[f+2]=255,a[f+3]=255;else{var b=9/c;d=Math.floor(256*b);b=Math.floor(256*b*b);a[f]=255;a[f+1]=b;a[f+2]=b;a[f+3]=256<=c?0:d}}return a}
window.onload=async function(){function a(l,r){l=r.stack;var g=p;l.b.uniformMatrix4fv(l.c,!1,g);l.a.push(g);console.log(m.data);{l=m;g=l.a.b;let t=l.c;null!=t?g.bindBuffer(g.ARRAY_BUFFER,t):(l.c=t=g.createBuffer(),g.bindBuffer(g.ARRAY_BUFFER,t),g.bufferData(g.ARRAY_BUFFER,l.f,g.STATIC_DRAW));g.activeTexture(g.TEXTURE0);l.a.bindTexture();g.uniform1i(r.j.texture,0);g.enableVertexAttribArray(r.g.texturePosition);g.vertexAttribPointer(r.g.texturePosition,2,g.FLOAT,!1,20,12);g.enableVertexAttribArray(r.g.position);
g.vertexAttribPointer(r.g.position,3,g.FLOAT,!1,20,0)}F(m,"white");x(r.stack,(n-16)/32,20-(k+16)/32);F(m,"main")}const c=document.getElementById("fps"),d=document.getElementById("canvas");var b=window.getComputedStyle(d),e=parseInt(b.getPropertyValue("width"),10);b=parseInt(b.getPropertyValue("height"),10);var h=window.devicePixelRatio||1;1!==h&&(d.width=h*e,d.height=h*b);e=d.getContext("webgl2",{antialias:!1,alpha:!1});e.enable(e.BLEND);e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);b=new z({b:e,
type:"vertex"},"#version 300 es\n\n    in vec3 a_position;\n    in vec2 a_texturePosition;\n\n    uniform mat4 u_projection;\n\n    out highp vec2 v_texturePosition;\n\n    void main() {\n        vec4 position = u_projection * vec4(a_position, 1);\n\n        gl_Position = position / position.w;\n        v_texturePosition = a_texturePosition;\n    }\n");h=new z({b:e,type:"fragment"},"#version 300 es\n    precision mediump float;\n\n    uniform sampler2D u_texture;\n\n    in highp vec2 v_texturePosition;\n    out vec4 output_color;\n\n    void main() {\n        vec4 color = texture(u_texture, v_texturePosition.st);\n        if (color.a == 0.0) {\n            discard;\n        }\n        output_color = color;\n    }\n");
const f=new B({b:e,m:"projection"});A(f,b,h).link();e=D({name:"fade",width:32,height:32,b:e,v:H()});const m=new G(e,{main:[[1,0,0,1,0,1,0,1,1,1,0,0,0,0,0,0,0,1,0,1]],white:[[40,0,0,.5,.5,40,0,20,.5,.5,0,0,0,.5,.5,0,0,20,.5,.5]]});let n=0,k=0;const p=new Float32Array([.05,0,0,0,0,0,0,0,0,.1,0,0,-1,-1,0,1]),q=new E;q.o=function(){c.innerHTML=`fps=${Math.round(q.c)}/${q.f}`;f.a.push(a);requestAnimationFrame(f.l)};q.start(60);d.onmousemove=l=>{n=l.offsetX;k=l.offsetY}};
